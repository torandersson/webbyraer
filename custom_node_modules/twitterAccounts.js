var http = require('http');
var cache = require('memory-cache');
var databaseUrl = "mongodb://webbyraer:givemethemilk@linus.mongohq.com:10083/webbyraer"; // "username:password@example.com/mydb"
var collections = ["facebook_pages", "twitter_accounts"]
var db = require("mongojs").connect(databaseUrl, collections);

var twitter_projections = {

  screen_name : 1,
  followers_count : 1

}


var getByIds = function(id,date,callback) {
	
   var dates = []
    ,  ids = [];
  
  if(!Array.isArray(date)) 
    dates.push(date);
  else
    dates = date;

  if(!Array.isArray(id)) 
    ids.push(id);
  else
    ids = id;

  var obj = cache.get("getByIds_"+ids.join()+"_"+dates.join());
  
  if(obj) {
		return process.nextTick(function () {
      return callback(null, obj);
    });
	}
  
	db.twitter_accounts.find({"collected_at": {$in: dates},  "screen_name" : { $in: ids }},twitter_projections, function(err, accounts) {
  	if( err || !accounts || accounts.length == 0){
  	}
  	cache.put("getByIds_"+ids.join()+"_"+dates.join(),accounts,60000);
  	console.log("accounts-db");
  	return callback(null,accounts);
	});
};


exports.getByIds = getByIds;
