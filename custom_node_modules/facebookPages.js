var http = require('http');
var cache = require('memory-cache');
var databaseUrl = "mongodb://tasty:good@linus.mongohq.com:10083/webbyraer"; // "username:password@example.com/mydb"
var collections = ["facebook_pages", "twitter_accounts"]
var db = require("mongojs").connect(databaseUrl, collections);

var facebook_projections = {
	name: 1,
	id : 1,
	likes : 1,
	checkins : 1,
	were_here_count : 1,
	talking_about_count : 1,
	about: 1,
	location:1,
	collected_at:1,
	website:1,
	link:1
};

var getByIds = function(id,date,callback) {

	 var dates = []
       , ids = [];

	if(!Array.isArray(date)) 
  		dates.push(date);
  	else
  		dates = date;

  	if(!Array.isArray(id)) 
  		ids.push(id);
  	else
  		ids = id;

  	var cacheKey = "getByIds_"+ids.join()+"_"+dates.join();

	var obj = cache.get(cacheKey);

	if(obj) {
		return process.nextTick(function () {
      		return callback(null, obj);
    	});
	}
	
	db.facebook_pages.find({"collected_at": {$in: dates}, "id": { $in: ids }},facebook_projections, function(err, pages) {
	  	
	  	if( err || pages == null || pages.length == 0) {
	  		return callback(err,pages);
	  	}

	  	console.log("pages",pages);
	  	
	  	cache.put(cacheKey,pages,60000);
	  	console.log("pages",pages);
	  	return callback(null,pages);
	});	
};

exports.getByIds = getByIds;
